<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®å°åˆ·å–®</title>
  <style>
    /* ---- ç¥¨é¢å°ºå¯¸ (10cm x 10cm) ---- */
    @page {
      size: 100mm 100mm;
      margin: 0;
    }

    :root {
      --pad-x: 8mm;     /* å·¦å³å…§è· */
      --pad-y: 10mm;    /* ä¸Šä¸‹åŸºç¤å…§è· */
      --gap: 6mm;       /* æ–‡å­—ä¹‹é–“é–“è· */
      --shift: 15mm;    /* ä¸‹ç§»è·é›¢ */
    }

    html, body { 
      height: 100%; 
      margin: 0; 
      padding: 0; 
      background: #fff; 
      font-family: 'Microsoft JhengHei', 'PingFang TC', 'Helvetica Neue', Arial, sans-serif;
    }

    /* ---- å–®å¼µç¥¨é¢ ---- */
    .ticket {
      width: 100mm;
      height: 100mm;
      box-sizing: border-box;
      padding: calc(var(--pad-y) + var(--shift)) var(--pad-x) var(--pad-y) var(--pad-x);
      background: #fff;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      gap: var(--gap);
      text-align: center;
      page-break-after: always;
      position: relative;
    }

    /* ---- æ–‡å­—æ¨£å¼ (é‡å°ç†±æ„Ÿæ‡‰ç´™å„ªåŒ–) ---- */
    .order-id {
      font-size: 60px;
      font-weight: 900;
      letter-spacing: 1px;
      line-height: 0.9;
      margin: 0;
      color: #000;
      font-family: 'Arial Black', 'Microsoft JhengHei', Arial, sans-serif;
      text-shadow: none;
    }
    
    .customer-name {
      font-size: 32px;
      font-weight: 700;
      line-height: 1.1;
      margin: 0;
      color: #000;
      max-width: 80mm;
      word-wrap: break-word;
      overflow-wrap: break-word;
    }
    
    .item-count {
      font-size: 24px;
      font-weight: 700;
      line-height: 1.2;
      margin: 0;
      color: #000;
      letter-spacing: 0.5px;
    }

    /* ---- ç°½æ”¶å–®å„ªåŒ– (å£“ç¸®ç‰ˆé¢é¿å…æ›é ) ---- */
    .sign-sheet {
      padding: calc(var(--pad-y) + var(--shift) - 8mm) var(--pad-x) calc(var(--pad-y) - 2mm) var(--pad-x);
      justify-content: flex-start;
    }
    
    .sign-sheet .sign-title {
      font-size: 20px;
      font-weight: 900;
      margin: 0 0 5mm 0;
      letter-spacing: 1px;
      color: #000;
      border-bottom: 1px solid #000;
      padding-bottom: 1mm;
      width: 100%;
    }
    
    .sign-sheet .sign-rows {
      width: 100%;
      display: grid;
      grid-template-columns: 22mm 1fr;
      row-gap: 2.5mm;
      column-gap: 3mm;
      text-align: left;
      font-size: 12px;
      line-height: 1.2;
      margin-bottom: 5mm;
    }
    
    .sign-sheet .sign-label { 
      font-weight: 700; 
      color: #000;
      white-space: nowrap;
    }
    
    .sign-sheet .sign-value { 
      font-weight: 600; 
      color: #000;
      word-break: break-all;
      overflow-wrap: break-word;
    }

    .sign-sheet .signature-box {
      width: 100%;
      border: 1px solid #000;
      border-radius: 2mm;
      padding: 3mm;
      box-sizing: border-box;
      flex: 1;
      min-height: 12mm;
      display: flex;
      align-items: flex-end;
      justify-content: flex-end;
      background: #fff;
    }
    
    .sign-sheet .signature-hint {
      font-size: 9px;
      color: #666;
      font-weight: 500;
    }

    /* ---- ç†±æ„Ÿæ‡‰ç´™åˆ—å°æœ€ä½³åŒ– ---- */
    @media print {
      .print-button { display: none !important; }
      
      * {
        -webkit-print-color-adjust: exact !important;
        print-color-adjust: exact !important;
      }
      
      .ticket {
        background: #fff !important;
        page-break-before: auto;
        page-break-after: always;
        page-break-inside: avoid;
        border: none !important;
        box-shadow: none !important;
      }
      
      .sign-sheet {
        padding: calc(var(--pad-y) + var(--shift) - 5mm) var(--pad-x) var(--pad-y) var(--pad-x) !important;
      }
      
      /* ç¢ºä¿æ–‡å­—æ¸…æ™° */
      .order-id, .customer-name, .item-count, 
      .sign-title, .sign-label, .sign-value {
        color: #000 !important;
        text-shadow: none !important;
      }
      
      .signature-box {
        border: 2px solid #000 !important;
        background: #fff !important;
      }
    }

    /* ---- è¢å¹•æ“ä½œæŒ‰éˆ• ---- */
    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      z-index: 1000;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      transition: background-color 0.2s;
    }
    
    .print-button:hover { 
      background: #218838; 
    }

    /* ---- éŸ¿æ‡‰å¼èª¿æ•´ ---- */
    @media screen and (max-width: 480px) {
      .print-button {
        top: 10px;
        right: 10px;
        padding: 8px 12px;
        font-size: 14px;
      }
    }
  </style>
</head>
<body>
  <!-- å¿«é€Ÿåˆ—å°æŒ‰éˆ• -->
  <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ¨™ç±¤</button>

  <%
    const small = parseInt(order.small_count || 0, 10);
    const large = parseInt(order.large_count || 0, 10);
    const totalCount = small + large;
    const count = totalCount;
  %>

  <!-- æ¯ä»¶ä¸€å¼µæ¨™ç±¤ -->
  <% for (let i = 1; i <= totalCount; i++) { %>
    <div class="ticket">
      <div class="order-id"><%= order.order_id %></div>
      <div class="customer-name"><%= order.name %></div>
      <div class="item-count">ç¬¬ <%= i %> ä»¶ã€€å…± <%= totalCount %> ä»¶</div>
    </div>
  <% } %>

  <!-- ç°½æ”¶å–®ï¼ˆæ¯ç­†è¨‚å–®æœ€å¾Œä¸€å¼µï¼‰ -->
  <div class="ticket sign-sheet">
    <div class="sign-title">é ˜ä»¶å–®</div>

    <div class="sign-rows">
      <div class="sign-label">è¨‚å–®ç·¨è™Ÿ</div>
      <div class="sign-value"><%= order.order_id %></div>

      <div class="sign-label">å§“å</div>
      <div class="sign-value"><%= order.name %></div>

      <div class="sign-label">é ˜ä»¶ä½ç½®</div>
      <div class="sign-value"><%= order.location_name || '-' %></div>

      <div class="sign-label">ä»¶æ•¸</div>
      <div class="sign-value">
        <%= count %> ä»¶
        <% 
          const parts = [];
          if (large > 0) parts.push(`å¤§${large}ä»¶`);
          if (small > 0) parts.push(`å°${small}ä»¶`);
        %>
        <% if (parts.length) { %>
          ï¼ˆ<%= parts.join('ã€') %>ï¼‰
        <% } %>
      </div>
    </div>

    <div class="signature-box">
      <span class="signature-hint">ç°½å / æ—¥æœŸ</span>
    </div>
  </div>
<script>
  // === å°è¡¨å®Œæˆå¾Œå›å ±å¾Œç«¯ ===
  (function () {
    const ORDER_ID = "<%= order.order_id %>";
    const KEY = "printed:" + ORDER_ID;

    // ç¢ºä¿åŒä¸€é ä¸é‡è¤‡å›å ±
    function alreadyReported() {
      try { return sessionStorage.getItem(KEY) === "1"; } catch (e) { return false; }
    }
    function markReported() {
      try { sessionStorage.setItem(KEY, "1"); } catch (e) {}
    }

    async function reportPrinted() {
      if (alreadyReported()) return;
      try {
        await fetch("/admin/printed/" + encodeURIComponent(ORDER_ID), {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ source: "afterprint" })
        });
        markReported();
        console.log("âœ… å·²å›å ±åˆ—å°å®Œæˆ");
      } catch (e) {
        console.warn("âš ï¸ å›å ±åˆ—å°å¤±æ•—", e);
      }
    }

    // åˆ—å°å°è©±æ¡†é—œé–‰å¾Œè§¸ç™¼
    window.addEventListener("afterprint", reportPrinted);

    // å‚™æ´ï¼šåµæ¸¬ print mode çµæŸ
    const mq = window.matchMedia("print");
    if (mq && mq.addEventListener) {
      mq.addEventListener("change", (e) => {
        if (!e.matches) reportPrinted();
      });
    }

    // è‹¥ä½¿ç”¨è€…ç›´æ¥é—œé–‰é é¢ï¼Œä¹Ÿå˜—è©¦å›å ±
    window.addEventListener("visibilitychange", () => {
      if (document.visibilityState === "hidden") reportPrinted();
    });
    window.addEventListener("pagehide", reportPrinted);
  })();
</script>

  <script>
    // å¿«æ·éµåˆ—å°
    document.addEventListener('keydown', function(e) {
      if (e.ctrlKey && (e.key === 'p' || e.key === 'P')) {
        e.preventDefault();
        window.print();
      }
    });

    // é é¢è¼‰å…¥å®Œæˆå¾Œæç¤º
    document.addEventListener('DOMContentLoaded', function() {
      console.log('ç†±æ„Ÿæ‡‰ç´™åˆ—å°å–®å·²è¼‰å…¥å®Œæˆ');
    });
  </script>
</body>
</html>
