<!DOCTYPE html>
<html lang="zh-TW">
<head>
  <meta charset="UTF-8">
  <title>è¨‚å–®å°åˆ·å–®</title>
  <style>
    @page { size: 100mm 100mm; margin: 0; }

    :root {
      --pad-x: 8mm;
      --pad-y: 10mm;
      --gap-sm: 5mm;
      --gap-md: 8mm;
    }

    html, body {
      margin: 0;
      padding: 0;
      background: #fff;
      font-family: 'Microsoft JhengHei', 'PingFang TC', 'Segoe UI', Arial, sans-serif;
    }

    /* ---- åŸºæœ¬ç¥¨é¢ ---- */
    .ticket {
      width: 100mm; height: 100mm;
      box-sizing: border-box;
      display: flex;
      flex-direction: column;
      justify-content: center;
      align-items: center;
      text-align: center;
      background: #fff;
      page-break-after: always;
      padding: var(--pad-y) var(--pad-x);
    }

    /* ===== æ¯ä»¶æ¨™ç±¤ï¼ˆLOGO + è¨‚å–® + å§“å + ä»¶æ•¸ï¼‰ ===== */
    .label .brand-logo {
      width: 60mm;     /* âœ… Logo å¯¬ 60mm */
      height: auto;
      margin-bottom: var(--gap-md);
      object-fit: contain;
    }

    .label .order-id {
      font-size: 64px;
      font-weight: 900;
      margin: 0;
      line-height: 1;
      letter-spacing: 1px;
      color: #000;
    }

    .label .customer-name {
      font-size: 30px;
      font-weight: 700;
      margin: var(--gap-sm) 0;
      line-height: 1.15;
      color: #000;
      max-width: 84mm;
      word-break: break-word;
    }

    .label .item-count {
      font-size: 22px;
      font-weight: 700;
      color: #000;
      letter-spacing: 0.3px;
      margin-top: var(--gap-sm);
    }

    /* ===== é ˜ä»¶å–®ï¼ˆä¿ç•™å³ä¸Šè§’ LOGOï¼‰ ===== */
    .sign-sheet {
      align-items: flex-start;
      text-align: left;
      padding: var(--pad-y) var(--pad-x);
    }

    .sign-header {
      width: 100%;
      display: flex;
      justify-content: space-between;
      align-items: center;
      border-bottom: 1px solid #000;
      padding-bottom: 3mm;
      margin-bottom: 6mm;
    }

    .sign-title {
      font-size: 20px;
      font-weight: 900;
      margin: 0;
      letter-spacing: 1px;
    }

    .brand-logo-small {
      width: 22mm;
      height: auto;
      object-fit: contain;
    }

    .sign-rows {
      width: 100%;
      display: grid;
      grid-template-columns: 24mm 1fr;
      row-gap: 3mm;
      column-gap: 4mm;
      font-size: 12px;
      line-height: 1.3;
    }

    .sign-label { font-weight: 700; }
    .sign-value { font-weight: 600; }

    .signature-box {
      width: 100%;
      border: 1px solid #000;
      border-radius: 2mm;
      padding: 3mm;
      min-height: 12mm;
      display: flex;
      justify-content: flex-end;
      align-items: flex-end;
      margin-top: 6mm;
    }

    .signature-hint {
      font-size: 9px;
      color: #666;
      font-weight: 500;
    }

    @media print {
      .print-button { display: none !important; }
      * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
      .brand-logo, .brand-logo-small {
        filter: grayscale(1) contrast(120%);
        image-rendering: -webkit-optimize-contrast;
      }
    }

    .print-button {
      position: fixed;
      top: 20px;
      right: 20px;
      padding: 12px 20px;
      background: #28a745;
      color: #fff;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      box-shadow: 0 2px 4px rgba(0,0,0,0.2);
      z-index: 1000;
    }

    .print-button:hover { background: #218838; }
  </style>
</head>
<body>
  <button class="print-button" onclick="window.print()">ğŸ–¨ï¸ åˆ—å°æ¨™ç±¤</button>

  <%
    const small = parseInt(order.small_count || 0, 10);
    const large = parseInt(order.large_count || 0, 10);
    const totalCount = (small + large) || 0;
    const hyphenId = (order.order_id || '').toString().replace(/^([A-Z]+)(\d+)/, '$1-$2');
  %>

  <!-- A. æ¯ä»¶æ¨™ç±¤ï¼ˆå« 60mm Logoï¼Œè¨‚å–®ç·¨è™Ÿè‡ªå‹•åŠ é€£å­—è™Ÿï¼‰ -->
  <% for (let i = 1; i <= totalCount; i++) { %>
    <div class="ticket label">
      <img class="brand-logo" src="https://www.mrluggagetw.com/img/logo.svg" alt="Mr. Luggage">
      <h1 class="order-id"><%= hyphenId %></h1>
      <p class="customer-name"><%= order.name %></p>
      <p class="item-count">ç¬¬ <%= i %> ä»¶ã€€å…± <%= totalCount %> ä»¶</p>
    </div>
  <% } %>

  <!-- B. é ˜ä»¶å–®ï¼ˆåŒæ¨£é¡¯ç¤ºåŠ é€£å­—è™Ÿçš„è¨‚å–®ç·¨è™Ÿï¼‰ -->
  <div class="ticket sign-sheet">
    <div class="sign-header">
      <div class="sign-title">é ˜ä»¶å–®</div>
      <img class="brand-logo-small" src="https://www.mrluggagetw.com/img/logo.svg" alt="Mr. Luggage">
    </div>

    <div class="sign-rows">
      <div class="sign-label">è¨‚å–®ç·¨è™Ÿ</div>
      <div class="sign-value"><%= hyphenId %></div>

      <div class="sign-label">å§“å</div>
      <div class="sign-value"><%= order.name %></div>

      <div class="sign-label">é ˜ä»¶ä½ç½®</div>
      <div class="sign-value"><%= order.location_name || '-' %></div>

      <%
        const parts = [];
        if (large > 0) parts.push(`å¤§${large}ä»¶`);
        if (small > 0) parts.push(`å°${small}ä»¶`);
      %>
      <div class="sign-label">ä»¶æ•¸</div>
      <div class="sign-value">
        <%= totalCount %> ä»¶ <% if (parts.length) { %>ï¼ˆ<%= parts.join('ã€') %>ï¼‰<% } %>
      </div>
    </div>

    <div class="signature-box">
      <span class="signature-hint">ç°½å / æ—¥æœŸ</span>
    </div>
  </div>

  <script>
    // === åˆ—å°å®Œæˆå›å ± ===
    (function () {
      const ORDER_ID = "<%= order.order_id %>";
      const KEY = "printed:" + ORDER_ID;
      function alreadyReported(){ try { return sessionStorage.getItem(KEY) === "1"; } catch(e){ return false; } }
      function markReported(){ try { sessionStorage.setItem(KEY, "1"); } catch(e){} }

      async function reportPrinted(){
        if (alreadyReported()) return;
        try{
          await fetch("/admin/printed/" + encodeURIComponent(ORDER_ID), {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ source: "afterprint" })
          });
          markReported();
          console.log("âœ… å·²å›å ±åˆ—å°å®Œæˆ");
        }catch(e){ console.warn("âš ï¸ å›å ±åˆ—å°å¤±æ•—", e); }
      }

      window.addEventListener("afterprint", reportPrinted);
    })();
  </script>
</body>
</html>
